### **1、基本概念**

ElasticSearch 是一个分布式、高扩展、高实时的搜索与数据分析引擎。

ElasticSearch（集群）中可以包含多个索引（数据库），每个索引中可以包含多个类型（表），每个类型下可以包含多个文档（行），每个文档中又包含多个字段（列）。

| 关系型数据库       | ElasticSearch          |
| ------------------ | ---------------------- |
| 数据库（Database） | 索引（Index）          |
| 表（Table）        | 类型（Type）逐渐被弃用 |
| 行（Row）          | 文档（Documents）      |
| 列（Column）       | 字段（Fields）         |
| 表结构信息         | 映射（Mapping）        |
| 分表               | 分片（Shards）         |

- **映射（Mapping）：**mapping是处理数据的方式和规则方面做一些限制，如：某个字段的数据类型、默认值、分析器、是否被索引等等。这些都是映射里面可以设置的，其他就是处理ES里面数据的一些使用规则设置也叫做映射，按着最优规则处理数据对性能提高很大，因此才需要建立映射，并且需要思考如何建立映射才能对性能更好。

- **分片（Shards）：**一个索引可以存储超出单个节点硬件限制的大量数据。比如，一个具有10亿文档数据的索引占用1TB的磁盘空间，而任一节点都可能没有这样大的磁盘空间，或者当个节点处理索引请求，响应太慢。为了解决这个问题，ES提供将索引划分成多份的能力，每一份就代表一个分片，创建索引时可以指定分片的数量。美誉个分片都是一个功能完善且独立的“索引”，这个“索引”可以被放置到集群中的任何节点。

- - 允许水平切割扩展容量
  - 允许在分片之上进行分布式的、并行的操作，提高性能和吞吐量

- **副本（Replicas）：**ES允许创建分片的一份或多份拷贝，这些拷贝就叫做副本

- - 提高可用性，一般副本不和主分片存储在同一个节点上
  - 扩展搜索量和吞吐量，因为搜索可以在所有的副本上并行运行

### **2、倒排索引**

可以被搜索的字段通过分词器将内容分为多个词，然后将每个词建立到文档ID的索引，这样就可以通过词进行搜索找到具体的文档。

在介绍倒排索引前先介绍一下正排索引，比如我们有一张表，里面有两个字段，id和content，如下：

| 文档ID | content        |
| ------ | -------------- |
| 1      | hello world    |
| 2      | hello bill     |
| 3      | ni hao shi jie |
| 4      | big world      |

正常情况下我们是以文档ID作为索引的，可以通过文档ID找到对应的文档内容，这种索引称为正排索引。假如我们需要通过world关键字进行查询，在传统的索引中这个并不好处理，所以出现了倒排索引，倒排索引是通过对关键字建立索引，反向关联到文档，如下：

| Term  | Count | DocumentId : Position |
| ----- | ----- | --------------------- |
| hello | 2     | 1:0, 2:0              |
| world | 2     | 1:1, 4:1              |
| bill  | 1     | 2:1                   |
| ni    | 1     | 3:0                   |
| hao   | 1     | 3:1                   |
| shi   | 1     | 3:2                   |
| jie   | 1     | 3:3                   |
| big   | 1     | 4:0                   |

倒排索引包含两个部分：

- 单词词典（Term Dictionary）：记录所有文档的单词，记录单词到倒排列表的关联关系。单词词典一般比较大，可以通过B+树或哈希拉链法实现，以满足高性能的插入与查询。

- 倒排列表（Posting List）：记录了单词对应的文档结合，由倒排索引项组成。

- - 倒排索引项（Posting）：

  - - 文档ID
    - 词频TF：该单词在文档中出现的次数，用于相关性评分
    - 位置（Position）：单词在文档中分词的位置，用于语句搜索（phrase query）
    - 偏移（Offset）：记录单词的开始结束位置，实现高亮显示

其他：

- ElasticSearch的JSON文档中的每个字段，都有自己的倒排索引。

- 可以指定对某些字段不做索引

- - 优点：节省存储空间
  - 缺点：字段无法被搜索